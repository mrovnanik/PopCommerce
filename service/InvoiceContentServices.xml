<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-2.0.xsd">
    <service verb="create" noun="InvoiceContent">
        <in-parameters>
            <auto-parameters entity-name="mantle.account.invoice.InvoiceContent" include="nonpk">
                <exclude field-name="contentLocation"/></auto-parameters>
            <parameter name="invoiceId" required="true"/>
            <parameter name="contentFile" type="org.apache.commons.fileupload.FileItem"/>
        </in-parameters>
        <out-parameters><parameter name="invoiceContentId"/></out-parameters>
        <actions>
            <if condition="contentFile != null &amp;&amp; contentFile.size &gt; 0">
                <service-call name="create#mantle.account.invoice.InvoiceContent" in-map="context" out-map="context"/>
                <service-call name="InvoiceContentServices.save#InvoiceContentFile" in-map="context"/></if>
        </actions>
    </service>
    <service verb="update" noun="InvoiceContent">
        <in-parameters>
            <!--<parameter name="productContentId" required="true"/>-->
            <parameter name="invoiceContentId" required="true"/>
            <auto-parameters entity-name="mantle.account.invoice.InvoiceContent" include="nonpk">
                <exclude field-name="contentLocation"/></auto-parameters>
            <parameter name="contentFile" type="org.apache.commons.fileupload.FileItem"/>
        </in-parameters>
        <actions>
            <if condition="contentFile != null &amp;&amp; contentFile.size &gt; 0">
                <entity-find-one entity-name="mantle.account.invoice.InvoiceContent" value-field="invoiceContent"/>
                <service-call name="InvoiceContentServices.save#ProductContentFile" out-map="context"
                              in-map="context + [invoiceId:invoiceContent.invoiceId, saveContentLocation:false]"/>
            </if>
            <service-call name="update#mantle.account.invoice.InvoiceContent" in-map="context"/>
        </actions>
    </service>
    <service verb="save" noun="InvoiceContentFile">
        <in-parameters>
            <parameter name="invoiceContentId" required="true"/>
            <parameter name="invoiceId" required="true"/>
            <parameter name="contentFile" type="org.apache.commons.fileupload.FileItem" required="true"/>
            <parameter name="saveContentLocation" type="Boolean" default="true"/>
        </in-parameters>
        <out-parameters><parameter name="contentLocation"/></out-parameters>
        <actions>
            <script>
                import javax.mail.internet.MimeUtility
                import org.moqui.impl.service.FileNameGenerator
            </script>

            <set field="filename" from="contentFile.getName()"/>

            <set field="displayName" from="filename"/>
            <set field="newFileName" from="null"/>
            <set field="newFileExtension" from="null"/>
            <script>
                FileNameGenerator fng = new FileNameGenerator(16)

                //file name being generated
                newFileName = fng.nextString()
                newFileExtension = filename.tokenize('.')[1]

                //display name
                displayName = MimeUtility.decodeText(filename.tokenize('.')[0]).replaceAll(' ', '_').replaceAll("[^a-zA-Z0-9_]+","") + "." + newFileExtension
            </script>

            <set field="contentRoot" from="ec.user.getPreference('mantle.content.root') ?: 'dbresource://mantle/content'"/>
            <set field="contentLocation" value="${contentRoot}/invoice/${invoiceId}/content_${invoiceContentId}/${newFileName}.${newFileExtension}"/>

            <set field="docRr" from="ec.resource.getLocationReference(contentLocation)"/>
            <script>
                fileStream = contentFile.getInputStream()
                try { docRr.putStream(fileStream) } finally { fileStream.close() }
            </script>

            <if condition="saveContentLocation"><service-call name="update#mantle.account.invoice.InvoiceContent"
                                                              in-map="[invoiceContentId:invoiceContentId, contentLocation:contentLocation, displayName:displayName]"/></if>
        </actions>
    </service>
</services>
